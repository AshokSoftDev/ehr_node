// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model Appointment {
  appointment_id     Int      @id @default(autoincrement())
  patient_id         Int
  doctor_id          String
  appointment_date   DateTime
  start_time         DateTime
  end_time           DateTime
  duration           Int?
  appointment_type   String
  reason_for_visit   String?
  appointment_status String
  notes              String?
  // Snapshot fields (denormalized for reporting/search)
  patient_mrn        String
  patient_title      String
  patient_firstName  String
  patient_lastName   String
  doctor_title       String
  doctor_firstName   String
  doctor_lastName    String
  doctor_specialty   String

  // Status & Audit
  status    Int       @default(1) // 1=active, 0=inactive / cancelled
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  // Relations
  patient Patient @relation(fields: [patient_id], references: [patient_id])
  doctor  Doctor  @relation(fields: [doctor_id], references: [id])
  visits  Visit[]
  clinicalNotes ClinicalNotes[]
  prescriptions Prescription[]

  @@index([patient_id])
  @@index([doctor_id])
  @@index([appointment_date])
  @@index([status])
}


// Billing Models: Invoice, InvoiceItem, Receipt

model Invoice {
    invoice_id     Int    @id @default(autoincrement())
    invoice_number String @unique
    patient_id     Int
    visit_id       Int

    // Totals (calculated)
    gross_total     Decimal @default(0)
    discount_type   String  @default("percentage") // "percentage" | "fixed"
    discount_value  Decimal @default(0)
    discount_amount Decimal @default(0) // Calculated discount
    tax_amount      Decimal @default(0)
    net_total       Decimal @default(0)

    // Additional fields
    coupon_code            String?
    coupon_discount_amount Decimal   @default(0)
    discount_reason        String?
    invoice_date           DateTime  @default(now())
    due_date               DateTime?
    notes                  String?

    status String @default("draft") // draft, sent, paid, cancelled

    // Audit fields
    createdAt DateTime  @default(now())
    createdBy String?
    updatedAt DateTime  @updatedAt
    updatedBy String?
    deletedAt DateTime?
    deletedBy String?

    // Relations
    patient  Patient       @relation(fields: [patient_id], references: [patient_id])
    visit    Visit         @relation(fields: [visit_id], references: [visit_id])
    items    InvoiceItem[]
    receipts Receipt[]

    @@index([patient_id])
    @@index([visit_id])
    @@index([invoice_number])
    @@index([status])
    @@index([invoice_date])
    @@index([createdAt])
    @@index([deletedAt])
}

model InvoiceItem {
    item_id    Int @id @default(autoincrement())
    invoice_id Int

    // Item details
    item_type    String // "drug" | "procedure" | "package" | "custom"
    item_name    String
    reference_id Int? // drug_id, procedure_id, etc.

    // Pricing
    quantity        Int     @default(1)
    unit_amount     Decimal @default(0)
    premium         Decimal @default(0)
    discount_type   String  @default("percentage") // "percentage" | "fixed"
    discount_value  Decimal @default(0)
    discount_amount Decimal @default(0)
    tax_applicable  Boolean @default(false)
    net_amount      Decimal @default(0)

    // Additional
    notes         String?
    assigned_user String?

    // Audit
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    invoice Invoice @relation(fields: [invoice_id], references: [invoice_id], onDelete: Cascade)

    @@index([invoice_id])
    @@index([item_type])
    @@index([reference_id])
}

model Receipt {
    receipt_id     Int    @id @default(autoincrement())
    receipt_number String @unique
    invoice_id     Int
    patient_id     Int

    amount         Decimal
    payment_method String // cash, card, upi, bank_transfer, other
    payment_date   DateTime @default(now())
    notes          String?

    // Audit
    status    Int       @default(1)
    createdAt DateTime  @default(now())
    createdBy String?
    updatedAt DateTime  @updatedAt
    updatedBy String?
    deletedAt DateTime?
    deletedBy String?

    // Relations
    invoice Invoice @relation(fields: [invoice_id], references: [invoice_id])
    patient Patient @relation(fields: [patient_id], references: [patient_id])

    @@index([invoice_id])
    @@index([patient_id])
    @@index([receipt_number])
    @@index([status])
    @@index([payment_date])
    @@index([createdAt])
    @@index([deletedAt])
}


model Doctor {
    id           String   @id @default(uuid())
    title        String
    firstName    String
    lastName     String
    dob          DateTime
    email        String   @unique
    licenceNo    String   @unique
    degree       String
    specialty    String
    timeBlock    String? // optional - stores values like "5min", "10min", "15min", "30min", "1hr", "1.5hr", "2hr", "3hr"
    displayName  String
    displayColor String // hex color code

    // Optional address fields
    address String?
    area    String?
    city    String?
    state   String?
    country String?
    pincode String?

    // Status field
    status Int @default(1) // 1=active, 0=inactive

    // Audit fields
    createdAt DateTime  @default(now())
    createdBy String?
    updatedAt DateTime  @updatedAt
    updatedBy String?
    deletedAt DateTime?
    deletedBy String?

    // Relations
    appointments  Appointment[]
    visits        Visit[]
    patientInfo   PatientInfo[]
    clinicalNotes ClinicalNotes[]
    prescriptions Prescription[]
    dentalHPIs    DentalHPI[]

    @@index([email])
    @@index([licenceNo])
    @@index([specialty])
    @@index([status])
    @@index([createdAt])
    @@index([deletedAt])
}


// Master data models: Insurance, Allergy

model Insurance {
  i_id           Int      @id @default(autoincrement())
  type           String
  company        String
  policy         String
  policyNo       String
  validationFrom DateTime
  validationTo   DateTime
  notes          String?

  // Status & Audit
  status    Int       @default(1) // 1=active, 0=inactive
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
}

model Allergy {
  allergy_id  Int    @id @default(autoincrement())
  allergyName String
  allergyType String

  // Status & Audit
  status    Int       @default(1) // 1=active, 0=inactive
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  // Relations
  patientAllergies PatientAllergy[]

  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
}

model Location {
  location_id   Int             @id @default(autoincrement())
  location_name String
  address       String?
  city          String
  state         String
  clinicalNotes ClinicalNotes[]

  // Status & Audit
  status    Int       @default(1) // 1=active, 0=inactive
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  @@index([status])
  @@index([active])
  @@index([createdAt])
  @@index([deletedAt])
}

model Drug {
  drug_id      Int     @id @default(autoincrement())
  drug_generic String
  drug_name    String
  drug_type    String
  drug_dosage  String
  drug_measure String
  amount       Decimal @default(0)
  instruction  String?

  prescriptions         Prescription[]         @relation("PrescriptionDrug")
  prescriptionTemplates PrescriptionTemplate[] @relation("PrescriptionTemplateDrug")

  // Status & Audit
  status    Int       @default(1) // 1=active, 0=inactive
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
}

model DocumentType {
  document_type_id Int     @id @default(autoincrement())
  type_name        String  @unique
  description      String?

  // Status & Audit
  status    Int       @default(1) // 1=active, 0=inactive
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  // Relations
  visitDocuments VisitDocument[]

  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
}


model Patient {
  patient_id    Int       @id @default(autoincrement())
  mrn           String    @unique
  title         String
  firstName     String
  lastName      String
  dateOfBirth   DateTime?
  age           Int?
  gender        String
  mobileNumber  String
  address       String
  area          String
  city          String
  state         String
  country       String
  pincode       String
  aadhar        String?
  referalSource String?
  comments      String?
  activeStatus  Int       @default(1)
  createdAt     DateTime  @default(now())
  createdBy     String
  updatedAt     DateTime  @updatedAt
  updatedBy     String

  // Relations
  appointments     Appointment[]
  visits           Visit[]
  patientAllergies PatientAllergy[]
  patientInfo      PatientInfo?
  patientEmergency PatientEmergency[]
  clinicalNotes    ClinicalNotes[]
  prescriptions    Prescription[]
  visitDocuments   VisitDocument[]
  dentalHPIs       DentalHPI[]
  invoices         Invoice[]
  receipts         Receipt[]
}

model PatientAllergy {
  id          Int     @id @default(autoincrement())
  patient_id  Int
  allergy_id  Int?
  allergyName String
  notes       String?

  // Status & Audit
  status    Int       @default(1) // 1=active, 0=inactive
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  // Relations
  patient Patient  @relation(fields: [patient_id], references: [patient_id])
  allergy Allergy? @relation(fields: [allergy_id], references: [allergy_id])

  @@index([patient_id])
  @@index([allergy_id])
  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
}

model PatientInfo {
  pi_id           Int       @id @default(autoincrement())
  patient_id      Int       @unique
  bloodGroup      String
  overseas        Boolean
  passportNumber  String?
  validityDate    DateTime?
  occupation      String?
  department      String?
  companyName     String?
  designation     String?
  employeeCode    String?
  primaryDoctorId String?
  activeStatus    Int       @default(1)
  createdAt       DateTime  @default(now())
  createdBy       String?
  updatedAt       DateTime  @updatedAt
  updatedBy       String?
  deletedAt       DateTime?
  deletedBy       String?

  patient Patient @relation(fields: [patient_id], references: [patient_id])
  doctor  Doctor? @relation(fields: [primaryDoctorId], references: [id])

  @@index([patient_id])
  @@index([primaryDoctorId])
  @@index([activeStatus])
}

model PatientEmergency {
  pe_id         Int       @id @default(autoincrement())
  patient_id    Int
  name          String
  relation      String
  contactNumber String
  status        Int       @default(1)
  createdAt     DateTime  @default(now())
  createdBy     String?
  updatedAt     DateTime  @updatedAt
  updatedBy     String?
  deletedAt     DateTime?
  deletedBy     String?

  patient Patient @relation(fields: [patient_id], references: [patient_id])

  @@index([patient_id])
  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
}


// ------------------- USER -------------------
model User {
    userId      String  @id @default(uuid())
    title       String
    fullName    String
    firstName   String
    lastName    String
    email       String  @unique
    phoneNumber String? // optional
    groupId     String? // root user may not belong to any group
    password    String

    parentId    String?
    accountType String  @default("child")

    createdAt DateTime @default(now())
    createdBy String?
    updatedAt DateTime @updatedAt
    updatedBy String?

    userStatus Int       @default(1) // 1=active, 0=inactive
    dob        DateTime? // optional
    otp        String?
    otpExpiry  DateTime?

    group Group? @relation(fields: [groupId], references: [id])

    parent   User?  @relation("ParentChild", fields: [parentId], references: [userId])
    children User[] @relation("ParentChild")

    creator      User?  @relation("UserCreator", fields: [createdBy], references: [userId])
    createdUsers User[] @relation("UserCreator")

    updater      User?  @relation("UserUpdater", fields: [updatedBy], references: [userId])
    updatedUsers User[] @relation("UserUpdater")

    @@index([email])
    @@index([groupId])
    @@index([userStatus])
    @@index([parentId])
    @@index([accountType])
    @@index([createdBy])
}

// ------------------- GROUP -------------------
model Group {
    id          String   @id @default(uuid())
    name        String   @unique
    description String?
    createdAt   DateTime @default(now())
    createdBy   String?
    updatedAt   DateTime @updatedAt
    updatedBy   String?

    users                User[]
    permissions          GroupModulePermission[]
    subModulePermissions GroupSubModulePermission[]
}

// ------------------- MODULE -------------------
model Module {
    id          String   @id @default(uuid())
    name        String   @unique
    description String?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    subModules  SubModule[]
    permissions GroupModulePermission[]
}

// ------------------- SUB-MODULE (Dynamic Actions) -------------------
model SubModule {
    id          String  @id @default(uuid())
    moduleId    String
    name        String // e.g. "Add", "Edit", "Delete", "Export"
    description String?

    module      Module                     @relation(fields: [moduleId], references: [id])
    permissions GroupSubModulePermission[]

    @@unique([moduleId, name]) // one action per module
}

// ------------------- GROUP MODULE PERMISSION -------------------
model GroupModulePermission {
    id        String  @id @default(uuid())
    groupId   String
    moduleId  String
    hasAccess Boolean @default(true)

    group                Group                      @relation(fields: [groupId], references: [id])
    module               Module                     @relation(fields: [moduleId], references: [id])
    subModulePermissions GroupSubModulePermission[]

    @@unique([groupId, moduleId])
    @@index([groupId])
    @@index([moduleId])
}

// ------------------- GROUP SUB-MODULE PERMISSION -------------------
model GroupSubModulePermission {
    id                      String  @id @default(uuid())
    groupId                 String
    subModuleId             String
    allowed                 Boolean @default(false)
    groupModulePermissionId String?

    group                 Group                  @relation(fields: [groupId], references: [id])
    subModule             SubModule              @relation(fields: [subModuleId], references: [id])
    groupModulePermission GroupModulePermission? @relation(fields: [groupModulePermissionId], references: [id])

    @@unique([groupId, subModuleId])
    @@index([groupId])
    @@index([subModuleId])
}


model Visit {
  visit_id         Int      @id @default(autoincrement())
  appointment_id   Int?
  patient_id       Int
  visit_date       DateTime
  location_id      Int?
  doctor_id        String
  visit_type       String
  reason_for_visit String?

  // Status & Audit
  status    Int       @default(1) // 1=active, 0=inactive
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  // Relations
  appointment   Appointment?    @relation(fields: [appointment_id], references: [appointment_id])
  patient       Patient         @relation(fields: [patient_id], references: [patient_id])
  doctor        Doctor?         @relation(fields: [doctor_id], references: [id])
  clinicalNotes ClinicalNotes[]
  prescriptions Prescription[]
  documents     VisitDocument[]
  dentalHPIs    DentalHPI[]
  invoices      Invoice[]

  @@index([appointment_id])
  @@index([patient_id])
  @@index([location_id])
  @@index([doctor_id])
  @@index([visit_date])
  @@index([status])
}

model DentalHPI {
  hpi_id     Int     @id @default(autoincrement())
  visit_id   Int
  patient_id Int
  doctor_id  String?

  // Dentition type: 'primary' | 'mixed' | 'permanent'
  dentition_type String

  // Teeth and surfaces - stored as JSON
  // Format: { "18": ["center", "leftTop"], "17": ["center"] }
  teeth_surfaces Json

  // Chief complaints - stored as JSON array
  // Format: ["toothache", "swelling", "cavity"]
  chief_complaints Json

  // Severity: 'mild' | 'moderate' | 'severe'
  severity String?

  // Duration - separate fields for flexibility
  duration_years  Int @default(0)
  duration_months Int @default(0)
  duration_weeks  Int @default(0)
  duration_days   Int @default(0)

  // Additional notes
  notes String?

  // Status & Audit
  status    Int       @default(1)
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  // Relations
  visit   Visit   @relation(fields: [visit_id], references: [visit_id])
  patient Patient @relation(fields: [patient_id], references: [patient_id])
  doctor  Doctor? @relation(fields: [doctor_id], references: [id])

  @@index([visit_id])
  @@index([patient_id])
  @@index([doctor_id])
  @@index([status])
}

model VisitDocument {
  document_id      Int     @id @default(autoincrement())
  visit_id         Int
  patient_id       Int
  document_type_id Int
  file_name        String // Original filename
  file_path        String // Relative path on disk
  description      String?
  mime_type        String // "application/pdf", "image/jpeg"
  file_size        Int // bytes

  // Status & Audit
  status    Int       @default(1)
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  // Relations
  visit        Visit        @relation(fields: [visit_id], references: [visit_id])
  patient      Patient      @relation(fields: [patient_id], references: [patient_id])
  documentType DocumentType @relation(fields: [document_type_id], references: [document_type_id])

  @@index([visit_id])
  @@index([patient_id])
  @@index([document_type_id])
  @@index([status])
}

model ClinicalNotes {
  cn_id          Int     @id @default(autoincrement())
  patient_id     Int
  appointment_id Int?
  visit_id       Int
  location_id    Int?
  doctor_id      String
  notes_type     String  @default("text") // 'text' | 'audio'
  editor_notes   String?
  transcription  String?
  audio_url      String?
  retry_count    Int     @default(0)

  // Status & Audit
  status    Int       @default(1) // 1=active, 0=inactive
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  // Relations
  patient     Patient      @relation(fields: [patient_id], references: [patient_id])
  appointment Appointment? @relation(fields: [appointment_id], references: [appointment_id])
  visit       Visit        @relation(fields: [visit_id], references: [visit_id])
  location    Location?    @relation(fields: [location_id], references: [location_id])
  doctor      Doctor       @relation(fields: [doctor_id], references: [id])

  @@index([patient_id])
  @@index([appointment_id])
  @@index([visit_id])
  @@index([doctor_id])
  @@index([location_id])
  @@index([status])
}

model Prescription {
  prescription_id Int     @id @default(autoincrement())
  visit_id        Int
  appointment_id  Int?
  patient_id      Int
  doctor_id       String?

  // Drug Master Fields (Snapshot)
  drug_id      Int?
  drug_name    String
  drug_generic String?
  drug_type    String?
  drug_dosage  String?
  drug_measure String?
  instruction  String?

  // Prescription Details
  duration      Int?
  duration_type String?
  quantity      Int?

  // Dosage Schedule
  morning_bf Boolean @default(false)
  morning_af Boolean @default(false)
  noon_bf    Boolean @default(false)
  noon_af    Boolean @default(false)
  evening_bf Boolean @default(false)
  evening_af Boolean @default(false)
  night_bf   Boolean @default(false)
  night_af   Boolean @default(false)

  notes String?

  // Status & Audit
  status    Int       @default(1) // 1=active, 0=inactive
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  // Relations
  visit       Visit        @relation(fields: [visit_id], references: [visit_id])
  appointment Appointment? @relation(fields: [appointment_id], references: [appointment_id])
  patient     Patient      @relation(fields: [patient_id], references: [patient_id])
  doctor      Doctor?      @relation(fields: [doctor_id], references: [id])
  drug        Drug?        @relation("PrescriptionDrug", fields: [drug_id], references: [drug_id])

  @@index([visit_id])
  @@index([appointment_id])
  @@index([patient_id])
  @@index([doctor_id])
  @@index([drug_id])
  @@index([status])
}

model PrescriptionTemplate {
  temp_id       Int    @id @default(autoincrement())
  template_id   BigInt
  template_name String

  // Drug Master Fields (Snapshot)
  drug_id      Int?
  drug_name    String
  drug_generic String?
  drug_type    String?
  drug_dosage  String?
  drug_measure String?
  instruction  String?

  // Prescription Details
  duration      Int?
  duration_type String?
  quantity      Int?

  // Dosage Schedule
  morning_bf Boolean @default(false)
  morning_af Boolean @default(false)
  noon_bf    Boolean @default(false)
  noon_af    Boolean @default(false)
  evening_bf Boolean @default(false)
  evening_af Boolean @default(false)
  night_bf   Boolean @default(false)
  night_af   Boolean @default(false)

  notes String?

  // Status & Audit
  status    Int       @default(1) // 1=active, 0=inactive
  createdAt DateTime  @default(now())
  createdBy String?
  updatedAt DateTime  @updatedAt
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?

  // Relations
  drug Drug? @relation("PrescriptionTemplateDrug", fields: [drug_id], references: [drug_id])

  @@index([template_id])
  @@index([drug_id])
  @@index([status])
}